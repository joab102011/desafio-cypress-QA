name: Cypress Tests - CI/CD

# Este workflow executa os testes automatizados do Cypress
# sempre que houver push ou pull request na branch main
# Seguindo as recomendaÃ§Ãµes do entrevistador de garantir qualidade contÃ­nua

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  # Job para executar testes no Chrome
  cypress-chrome:
    name: Cypress Tests - Chrome
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Executar testes em paralelo para acelerar execuÃ§Ã£o
        containers: [1, 2]
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Instalar dependÃªncias
        run: npm ci
      
      - name: Executar testes Cypress no Chrome
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headless: true
          record: false
          parallel: true
          ci-build-id: ${{ github.run_id }}-${{ github.run_attempt }}
          group: 'Chrome Tests'
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload screenshots em caso de falha
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-chrome
          path: cypress/screenshots
          retention-days: 7
      
      - name: Upload vÃ­deos dos testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos-chrome
          path: cypress/videos
          retention-days: 7
      
      - name: Upload relatÃ³rios
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-reports-chrome
          path: cypress/reports
          retention-days: 7

  # Job para executar testes no Firefox
  cypress-firefox:
    name: Cypress Tests - Firefox
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Instalar dependÃªncias
        run: npm ci
      
      - name: Executar testes Cypress no Firefox
        uses: cypress-io/github-action@v6
        with:
          browser: firefox
          headless: true
          record: false
          group: 'Firefox Tests'
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload screenshots em caso de falha
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-firefox
          path: cypress/screenshots
          retention-days: 7
      
      - name: Upload vÃ­deos dos testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos-firefox
          path: cypress/videos
          retention-days: 7

  # Job para executar testes no Edge
  cypress-edge:
    name: Cypress Tests - Edge
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Instalar dependÃªncias
        run: npm ci
      
      - name: Executar testes Cypress no Edge
        uses: cypress-io/github-action@v6
        with:
          browser: edge
          headless: true
          record: false
          group: 'Edge Tests'
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload screenshots em caso de falha
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-edge
          path: cypress/screenshots
          retention-days: 7
      
      - name: Upload vÃ­deos dos testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos-edge
          path: cypress/videos
          retention-days: 7

  # Job para gerar relatÃ³rio consolidado
  generate-report:
    name: Gerar RelatÃ³rio Consolidado
    runs-on: ubuntu-latest
    needs: [cypress-chrome, cypress-firefox, cypress-edge]
    if: always()
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
      
      - name: Instalar dependÃªncias
        run: npm ci
      
      - name: Gerar relatÃ³rio HTML
        run: |
          echo "## ðŸ“Š RelatÃ³rio de Testes Cypress" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Testes executados com sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Os testes foram executados nos seguintes navegadores:" >> $GITHUB_STEP_SUMMARY
          echo "- Chrome" >> $GITHUB_STEP_SUMMARY
          echo "- Firefox" >> $GITHUB_STEP_SUMMARY
          echo "- Edge" >> $GITHUB_STEP_SUMMARY
      
      - name: Comentar no PR (se aplicÃ¡vel)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Testes automatizados executados com sucesso em todos os navegadores!'
            })

